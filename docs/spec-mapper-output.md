# Loom Mapper Output Specification

## Overview

This document defines the output file formats produced by the mapper. All
formats are deterministic given identical inputs and mapper settings.

Output files are generated in Stage C of the Loom pipeline
([spec-cli.md](./spec-cli.md)).

## Output Files

| File | Flag | Description |
|------|------|-------------|
| `<name>.config.bin` | always (with `--adg` + sources) | Binary config_mem image |
| `<name>_addr.h` | always (with `--adg` + sources) | C header with per-node addresses |
| `<name>.mapping.json` | `--dump-mapping` | Machine-readable mapping report |

## mapping.json Schema

The mapping report is a JSON file serialized from `MappingState`
([spec-mapper-model.md](./spec-mapper-model.md)). It contains the
complete placement, routing, and temporal assignment information.

```json
{
  "version": 1,
  "status": "success" | "failed",
  "profile": "<mapper-profile-name>",
  "seed": <int>,

  "placement": {
    "<sw_node_id>": {
      "hwNode": "<hw_node_id>",
      "hwNodeName": "<symbol_name>",
      "swOp": "<mlir_op_name>",
      "swLoc": "<file>:<line>" | null
    }
  },

  "portBinding": {
    "<sw_port_id>": "<hw_port_id>"
  },

  "routes": {
    "<sw_edge_id>": {
      "srcSwPort": "<sw_port_id>",
      "dstSwPort": "<sw_port_id>",
      "hwPath": [
        {"src": "<hw_port_id>", "dst": "<hw_port_id>"},
        ...
      ],
      "tag": <int> | null
    }
  },

  "temporal": {
    "<sw_node_id>": {
      "temporalPE": "<hw_virtual_node_id>",
      "slot": <int>,
      "tag": <int>,
      "opcode": <int>
    }
  },

  "registers": {
    "<sw_edge_id>": {
      "temporalPE": "<hw_virtual_node_id>",
      "registerIndex": <int>
    }
  },

  "cost": {
    "total": <float>,
    "placementPressure": <float>,
    "routingCost": <float>,
    "temporalCost": <float>,
    "perfProxy": <float>,
    "configFootprint": <float>
  },

  "diagnostics": {
    "unmappedNodes": ["<sw_node_id>", ...],
    "failedEdges": ["<sw_edge_id>", ...],
    "firstViolatedConstraint": "<C1>" | "<C2>" | ... | null,
    "conflictingResources": [
      {"sw": "<sw_id>", "hw": "<hw_id>", "reason": "<description>"}
    ]
  }
}
```

### Field Descriptions

**Top-level fields:**

| Field | Type | Description |
|-------|------|-------------|
| `version` | int | Schema version (currently 1) |
| `status` | string | `"success"` or `"failed"` |
| `profile` | string | Mapper profile name used |
| `seed` | int | Deterministic seed used |

**placement**: Maps each placed SW node to its HW node. Keys are
string-encoded `IdIndex` values from `MappingState.swNodeToHwNode`.
Sentinel nodes are excluded (they use port binding, not placement).

**portBinding**: Maps each bound SW port to its HW port. Includes
sentinel port bindings from `MapPort`.

**routes**: Maps each routed SW edge to its HW path. `hwPath` is an
ordered list of port-pair hops matching
`MappingState.swEdgeToHwPaths`. `tag` is the assigned tag value for
tagged edge sharing (null for exclusive edges).

**temporal**: Temporal PE assignments for SW nodes mapped to temporal
FU nodes. Only present for temporal PE mappings.

**registers**: Internal temporal register assignments for intra-PE
edges. Only present when temporal registers are used.

**cost**: All five cost metric families from
[spec-mapper-cost.md](./spec-mapper-cost.md).

**diagnostics**: Present when `status` is `"failed"`. Contains
unmapped nodes, failed edges, first violated constraint class, and
conflicting resource pairs.

## config.bin Format

Binary `config_mem` image. Layout and bit packing rules follow
[spec-fabric-config_mem.md](./spec-fabric-config_mem.md).

The file is a flat binary blob of `total_config_words * word_width / 8`
bytes, written in little-endian byte order.

## addr.h Format

C header file with `#define` constants for per-node configuration
addresses and masks. Used by the host runtime to program `config_mem`.

```c
// Auto-generated by loom mapper
#ifndef <NAME>_ADDR_H
#define <NAME>_ADDR_H

#define LOOM_CONFIG_DEPTH <total_config_words>
#define LOOM_CONFIG_WIDTH <word_width_bits>

// Per-node base addresses (word offset in config_mem)
#define LOOM_ADDR_<NODE_NAME> <word_offset>

// Per-node config word count
#define LOOM_SIZE_<NODE_NAME> <word_count>

#endif
```

## Relationship to Visualization Data

The `mapping.json` file and the HTML viewer's embedded JSON
([spec-viz-mapped.md](./spec-viz-mapped.md)) serve different purposes:

- `mapping.json`: complete machine-readable report for tooling and
  `--viz-mapped` standalone visualization input.
- Embedded HTML JSON (`mappingData`, `nodeMetadata`, `dotSources`):
  viewer-specific data derived from `mapping.json` content plus DOT
  generation. The `HTMLViewer` exporter reads `mapping.json` (or
  `MappingState` directly) and produces the embedded JSON.

When `--viz-mapped <mapping.json>` is invoked, the viewer reads the
mapping.json file and generates the embedded viewer JSON internally.

## Related Documents

- [spec-mapper.md](./spec-mapper.md)
- [spec-mapper-model.md](./spec-mapper-model.md)
- [spec-mapper-cost.md](./spec-mapper-cost.md)
- [spec-cli.md](./spec-cli.md)
- [spec-fabric-config_mem.md](./spec-fabric-config_mem.md)
- [spec-viz-mapped.md](./spec-viz-mapped.md)
